<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ポケモン計算 PWA</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b74de" />
  <style>
    :root{--brand:#0b74de;--bg:#f6f7fb;--card:#fff;--muted:#666}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans JP',sans-serif;margin:0;background:var(--bg);color:#222}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--brand);color:#fff;position:sticky;top:0;z-index:2}
    main{padding:16px;max-width:1100px;margin:0 auto}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
    .tab{border:1px solid #cfe0ff;border-radius:999px;background:#e9f1ff;color:#1c4fbf;padding:6px 12px;font-weight:700;cursor:pointer}
    .tab.active{background:#1c4fbf;color:#fff;border-color:#1c4fbf}
    .grid{display:grid;gap:12px}
    @media(min-width:980px){.grid-2{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.06);padding:16px}
    h2,h3{margin:.2em 0 .6em}
    label{font-size:.95em}
    input[type="number"],input[type="text"],select{width:100%;padding:8px;border:1px solid #ddd;border-radius:10px}
    .row{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center;margin:8px 0}
    .row3{display:grid;grid-template-columns:120px 1fr 1fr;gap:10px;align-items:center;margin:8px 0}
    .btn{border:0;border-radius:10px;padding:10px 14px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
    .muted{color:var(--muted);font-size:.95em}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef4ff;color:#2a58b5;font-weight:700}
    .hpbar{height:14px;background:#e5e7eb;border-radius:10px;overflow:hidden}
    .hpbar>div{height:100%;background:#22c55e;width:0%}
    textarea{width:100%;height:140px;padding:10px;border:1px solid #ddd;border-radius:8px}
    details{background:#f9fafb;border:1px solid #eee;border-radius:10px;padding:10px}
    details>summary{cursor:pointer;font-weight:600;margin:4px 0}
    .tight{display:flex;gap:8px;flex-wrap:wrap}
    .hidden{display:none}
    .suggest{position:relative}
    .suggest ul{position:absolute;z-index:3;left:0;right:0;top:100%;background:#fff;border:1px solid #ddd;border-radius:8px;margin:4px 0 0;padding:4px;max-height:220px;overflow:auto}
    .suggest li{list-style:none;padding:6px 8px;border-radius:6px;cursor:pointer}
    .suggest li:hover{background:#f2f6ff}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:6px 8px;text-align:left}
    .party-grid{display:grid;gap:12px}
    @media(min-width:980px){.party-grid{grid-template-columns:1fr 1fr}}
    .slot-h{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .slot-h small{color:var(--muted)}

    /* Timer */
    .timer-wrap{display:flex;flex-direction:column;align-items:center;gap:12px}
    .timer-display{font-size:48px;font-weight:800;letter-spacing:1px}
    .timer-ctrl{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
    .timer-ctrl .row{grid-template-columns:80px 120px}
  </style>
</head>
<body>
  <header>
    <div>ポケモン計算 PWA</div>
    <div class="tight">
      <span id="swStatus" class="pill">SW 準備中</span>
      <button id="installBtn" class="btn btn-ghost" hidden>ホーム画面に追加</button>
    </div>
  </header>

  <main>
    <div class="tabs">
      <button class="tab active" data-tab="calc" type="button">計算</button>
      <button class="tab" data-tab="dex" type="button">図鑑 / パーティ</button>
      <button class="tab" data-tab="timer" type="button">タイマー</button>
    </div>

    <!-- ============ 計算タブ ============ -->
    <section id="tab-calc">
      <div class="grid grid-2">
        <!-- 攻撃側 -->
        <div class="card">
          <h2>攻撃側</h2>
          <div class="row3">
            <label>実数値（攻撃）</label>
            <input id="atkA" type="number" min="1" value="200" />
            <button class="btn btn-ghost" onclick="copyFromAtkCalc('A')">← 実数値計</button>
          </div>
          <div class="row3">
            <label>実数値（特攻）</label>
            <input id="atkS" type="number" min="1" value="200" />
            <button class="btn btn-ghost" onclick="copyFromAtkCalc('S')">← 実数値計</button>
          </div>

          <details>
            <summary>実数値計（攻撃/特攻）</summary>
            <div class="row3"><label>対象</label>
              <select id="atkCalcTarget">
                <option value="攻撃">攻撃</option>
                <option value="特攻">特攻</option>
              </select>
              <span class="muted">レベル50固定</span>
            </div>
            <div class="row3"><label>種族値</label><input id="atkBase" type="number" min="1" max="255" value="130" /><span></span></div>
            <div class="row3"><label>個体値</label><input id="atkIV" type="number" min="0" max="31" value="31" /><span></span></div>
            <div class="row3"><label>努力値</label><input id="atkEV" type="number" min="0" max="252" value="252" /><span></span></div>
            <div class="row3"><label>補正</label>
              <select id="atkNature">
                <option value="1.1">1.1倍</option>
                <option value="1.0" selected>1.0倍</option>
                <option value="0.9">0.9倍</option>
              </select>
              <button class="btn" onclick="runAtkCalc()">計算して反映</button>
            </div>
            <div class="row"><label>結果</label><div id="atkCalcOut" class="pill">—</div></div>
          </details>
        </div>

        <!-- 防御側 -->
        <div class="card">
          <h2>防御側</h2>
          <div class="row3">
            <label>実数値（HP）</label>
            <input id="defHP" type="number" min="1" value="155" />
            <button class="btn btn-ghost" onclick="copyFromDefCalc('HP')">← 実数値計</button>
          </div>
          <div class="row3">
            <label>実数値（防御）</label>
            <input id="defB" type="number" min="1" value="120" />
            <button class="btn btn-ghost" onclick="copyFromDefCalc('B')">← 実数値計</button>
          </div>
          <div class="row3">
            <label>実数値（特防）</label>
            <input id="defD" type="number" min="1" value="120" />
            <button class="btn btn-ghost" onclick="copyFromDefCalc('D')">← 実数値計</button>
          </div>

          <details>
            <summary>実数値計（HP/防御/特防）</summary>
            <div class="row3"><label>対象</label>
              <select id="defCalcTarget">
                <option value="HP">HP</option>
                <option value="防御">防御</option>
                <option value="特防">特防</option>
              </select>
              <span class="muted">レベル50固定</span>
            </div>
            <div class="row3"><label>種族値</label><input id="defBase" type="number" min="1" max="255" value="100" /><span></span></div>
            <div class="row3"><label>個体値</label><input id="defIV" type="number" min="0" max="31" value="31" /><span></span></div>
            <div class="row3"><label>努力値</label><input id="defEV" type="number" min="0" max="252" value="0" /><span></span></div>
            <div class="row3"><label>補正（HP以外）</label>
              <select id="defNature">
                <option value="1.1">1.1倍</option>
                <option value="1.0" selected>1.0倍</option>
                <option value="0.9">0.9倍</option>
              </select>
              <button class="btn" onclick="runDefCalc()">計算して反映</button>
            </div>
            <div class="row"><label>結果</label><div id="defCalcOut" class="pill">—</div></div>
          </details>
        </div>
      </div>

      <!-- 設定 -->
      <div class="card">
        <h2>ダメージ設定</h2>
        <div class="grid grid-2">
          <div>
            <div class="row"><label>技区分</label>
              <select id="category">
                <option>物理</option>
                <option>特殊</option>
              </select>
            </div>
            <div class="row"><label>威力</label><input id="power" type="number" min="1" value="50" /></div>

            <div class="row"><label>技タイプ</label>
              <select id="moveType">
                <option>ノーマル</option><option>ほのお</option><option>みず</option><option>でんき</option><option>くさ</option><option>こおり</option>
                <option>かくとう</option><option>どく</option><option>じめん</option><option>ひこう</option><option>エスパー</option><option>むし</option>
                <option>いわ</option><option>ゴースト</option><option>ドラゴン</option><option>あく</option><option>はがね</option><option>フェアリー</option>
              </select>
            </div>

            <div class="row"><label>STAB</label>
              <select id="stab">
                <option value="1.0">1.0</option>
                <option value="1.5" selected>1.5</option>
                <option value="2.0">2.0</option>
              </select>
            </div>
            <div class="row"><label>タイプ相性</label>
              <select id="typeMul">
                <option value="0.25">0.25</option>
                <option value="0.5">0.5</option>
                <option value="1.0" selected>1.0</option>
                <option value="2.0">2.0</option>
                <option value="4.0">4.0</option>
              </select>
            </div>
          </div>

          <div>
            <div class="row"><label>天候</label>
              <select id="weather">
                <option>なし</option>
                <option>晴れ</option>
                <option>雨</option>
                <option>砂嵐</option>
                <option>雪</option>
              </select>
            </div>
            <div class="row"><label>アイテム</label>
              <select id="item">
                <option>なし</option>
                <option>こだわりハチマキ</option>
                <option>こだわりメガネ</option>
                <option>いのちのたま</option>
              </select>
            </div>
            <div class="row"><label>状態</label>
              <select id="status">
                <option>通常</option>
                <option>やけど</option>
              </select>
            </div>
            <div class="row"><label>攻撃ランク</label>
              <select id="atkStage"></select>
            </div>
            <div class="row"><label>防御ランク</label>
              <select id="defStage"></select>
            </div>
            <div class="row"><label>連続回数</label>
              <select id="hits"></select>
            </div>
            <div class="row"><label>砂嵐・岩特防1.5</label>
              <select id="sandRock">
                <option value="0">オフ</option>
                <option value="1">オン</option>
              </select>
            </div>
            <div class="row"><label>雪・氷防御1.5</label>
              <select id="snowIce">
                <option value="0">オフ</option>
                <option value="1">オン</option>
              </select>
            </div>
            <div class="row"><label>その他補正</label>
              <input id="otherMul" type="number" step="0.05" min="0" value="1.0" />
            </div>
          </div>
        </div>

        <div class="tight" style="margin-top:10px">
          <button class="btn" onclick="previewDamage()">計算する（HPは減らさない）</button>
          <button class="btn btn-ghost" onclick="doAttack()">攻撃する（乱数適用）</button>
          <button class="btn btn-ghost" onclick="resetHP()">HP/ログ リセット</button>
        </div>
      </div>

      <!-- HP & 結果 -->
      <div class="card">
        <h3>防御側 HP</h3>
        <div class="row">
          <label>現在 / 最大</label>
          <div id="hpText">0 / 0 (0%)</div>
        </div>
        <div class="hpbar"><div id="hpFill"></div></div>

        <div style="margin-top:12px">
          <div id="resultLine" class="muted">結果がここに出ます</div>
          <ul id="resultList"></ul>
        </div>
      </div>

      <!-- ログ -->
      <div class="card">
        <h3>ログ</h3>
        <textarea id="log" readonly></textarea>
      </div>
    </section>

    <!-- ============ 図鑑/パーティ タブ ============ -->
    <section id="tab-dex" class="hidden">
      <div class="card">
        <h2>図鑑検索</h2>
        <div class="row suggest">
          <label>ポケモン名/番号</label>
          <div>
            <input id="dexSearch" type="text" placeholder="例）ピカ / 25 / テラパゴス" list="pkmnlist" />
            <ul id="dexSuggest" class="hidden"></ul>
          </div>
        </div>
        <datalist id="pkmnlist"></datalist>
        <img id="dexImg" alt="" style="margin-top:6px;max-height:120px;display:none">
        <div id="dexInfo" class="muted" style="margin-top:8px">未選択</div>

        <details style="margin-top:10px">
          <summary>実数値計（HP/攻撃/防御/特攻/特防/素早）</summary>
          <div class="row3"><label>対象</label>
            <select id="dexTarget">
              <option>HP</option><option>攻撃</option><option>防御</option>
              <option selected>特攻</option><option>特防</option><option>素早</option>
            </select>
            <span class="muted">Lv50固定</span>
          </div>
          <div class="row3"><label>種族値</label><input id="dexBase" type="number" min="1" max="255" value="100" /><span></span></div>
          <div class="row3"><label>個体値</label><input id="dexIV" type="number" min="0" max="31" value="31" /><span></span></div>
          <div class="row3"><label>努力値</label><input id="dexEV" type="number" min="0" max="252" value="0" /><span></span></div>
          <div class="row3"><label>補正（HP以外）</label>
            <select id="dexNature">
              <option value="1.1">1.1倍</option>
              <option value="1.0" selected>1.0倍</option>
              <option value="0.9">0.9倍</option>
            </select>
            <button class="btn" onclick="runDexCalc()">計算</button>
          </div>
          <div class="row"><label>結果</label><div id="dexOut" class="pill">—</div></div>

          <div class="tight" style="margin-top:6px">
            <button class="btn btn-ghost" onclick="applyToCalc('atk')">→ 攻撃側へ反映</button>
            <button class="btn btn-ghost" onclick="applyToCalc('def')">→ 防御側へ反映</button>
          </div>
        </details>
      </div>

      <div class="card">
        <h2>パーティ作成（6体）</h2>
        <div class="party-grid" id="partyGrid"></div>

        <div class="tight" style="margin-top:10px">
          <input id="partySaveName" placeholder="保存名（例：シーズン1）」 />
          <button class="btn" onclick="saveParty()">この6体を保存</button>
          <select id="partyList"></select>
          <button class="btn btn-ghost" onclick="loadParty()">読み込み</button>
          <button class="btn btn-ghost" onclick="deleteParty()">削除</button>
        </div>
      </div>
    </section>

    <!-- ============ タイマー タブ ============ -->
    <section id="tab-timer" class="hidden">
      <div class="card">
        <h2>タイマー</h2>
        <div class="timer-wrap">
          <div id="timerDisplay" class="timer-display">10:00</div>
          <div class="timer-ctrl">
            <div class="row"><label>分</label><input id="timerMin" type="number" min="0" value="10"></div>
            <div class="row"><label>秒</label><input id="timerSec" type="number" min="0" max="59" value="0"></div>
            <button class="btn" id="timerStartBtn" type="button" onclick="toggleTimer()">開始</button>
            <button class="btn btn-ghost" id="timerResetBtn" type="button" onclick="resetTimer()">リセット</button>
          </div>
          <div class="muted">タブを切り替えても動作します。</div>
        </div>
      </div>
    </section>
  </main>

  <script src="app.js"></script>
</body>
</html>
